name: Build & Test

# Ausführlich kommentierter Build- und Test-Workflow für Backend (Go)
# und Frontend (Elm/Node). Triggert automatisch auf Änderungen
# und kann manuell gestartet werden, um lokale Modifikationen schnell zu prüfen.
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  backend:
    name: Backend – Go Build & Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      # Der Checkout stellt sicher, dass der Arbeitsbaum vorhanden ist.
      - name: Repository auschecken
        uses: actions/checkout@v4

      # Go-Installation mit fester Version für reproduzierbare Builds.
      - name: Go einrichten
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      # Abhängigkeiten cachen, um Laufzeiten bei Folgeläufen zu senken.
      - name: Go Module Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      # Modulabhängigkeiten synchronisieren (keine Änderungen committen,
      # aber sicherstellen, dass Tests mit aktuellem Stand laufen).
      - name: go mod tidy (Validierung)
        run: go mod tidy

      # Tests inklusive Verbose-Ausgabe, um Fehlersuche zu erleichtern.
      - name: Tests ausführen
        run: go test ./... -v

      # Optionaler Build, um sicherzustellen, dass der Server kompiliert.
      - name: Server-Binary bauen
        run: CGO_ENABLED=0 GOOS=linux go build -o server ./cmd/server

      # Artefakt-Upload erleichtert Debugging und Weiterverwendung im Docker-Build.
      - name: Build-Artefakt hochladen
        uses: actions/upload-artifact@v4
        with:
          name: backend-server
          path: backend/server

  frontend:
    name: Frontend – Elm Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Repository auschecken
        uses: actions/checkout@v4

      # Node 20 bietet aktuelle LTS-Funktionalität für npm und Skripte.
      - name: Node einrichten
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      # Elm global bereitstellen, damit elm make verfügbar ist.
      - name: Elm installieren
        run: npm install -g elm

      # Frontend-Abhängigkeiten installieren (npm ci bevorzugt).
      - name: Abhängigkeiten installieren
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f package.json ]; then
            npm install
          else
            echo "Keine package.json gefunden – Schritt übersprungen.";
          fi

      # Elm-Build als smoke test; ein eigener Test-Runner ist nicht vorhanden.
      - name: Elm Build durchführen
        run: |
          mkdir -p dist
          elm make src/Main.elm --output=dist/main.js

      # Artefakt-Upload ermöglicht optionales Deploy aus Build-Ausgaben.
      - name: Frontend-Artefakt hochladen
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/main.js

  summary:
    name: Zusammenfassung
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    steps:
      # Übersichtlicher Abschluss-Job, der nur den Status weitergibt.
      - name: Erfolgreiche Builds bestätigen
        run: echo "Backend und Frontend erfolgreich gebaut und getestet."
